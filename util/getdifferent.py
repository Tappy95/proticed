import asyncio

import copy
from sqlalchemy import Table, Column, PrimaryKeyConstraint, Integer, String, TIMESTAMP, \
    Boolean, TEXT, DECIMAL, SMALLINT, Float, Date, DateTime
from sqlalchemy.dialects.mysql import TINYINT
from models import metadata

from aiomysql.sa import create_engine
from sqlalchemy.sql import select
from sqlalchemy.dialects.mysql import insert
from config import *

un = [1, 1281, 14339, 260, 267, 1293, 170638, 172176, 170769, 131090, 281, 1305, 26395, 12576, 184609, 293, 550, 2984,
      159912, 45100, 10542, 11700, 3252, 15032, 11450, 316, 63, 40005, 9800, 58058, 11730, 9815, 260059, 220, 11232,
      11233, 64482, 1249, 99, 353, 870, 20710, 172008, 14308, 619, 11116, 237, 6000, 20081, 625, 3187, 22128, 888,
      172036, 40965, 73733, 180235, 12, 24, 180250, 27, 34, 35, 147506, 51, 57, 63, 122950, 81, 32852, 114782, 100,
      16486, 73830, 73831, 16491, 113, 115, 73846, 120, 180345, 121, 124, 137, 138, 152, 172187, 159, 162, 165, 172206,
      82099, 192, 195, 196, 197, 8392, 202, 203, 211, 212, 8403, 123099, 222, 233, 114921, 106732, 238, 246, 253, 256,
      261, 268, 82190, 280, 288, 299, 301, 302, 305, 308, 309, 310, 316, 317, 319, 74050, 98633, 329, 172378, 355, 357,
      359, 360, 33131, 381, 382, 386, 387, 57738, 397, 412, 98717, 8605, 417, 421, 422, 115117, 430, 436, 8636, 115145,
      115148, 8662, 98776, 476, 491, 98795, 115180, 115194, 172539, 115195, 172538, 164352, 8710, 8717, 530, 123416,
      41498, 156196, 548, 550, 551, 552, 553, 554, 131625, 556, 98863, 559, 562, 107059, 8754, 139836, 139839, 33346,
      581, 582, 593, 597, 49750, 602, 8802, 617, 618, 8820, 156277, 631, 8824, 633, 8830, 98952, 156323, 98982, 8875,
      66229, 8894, 139971, 139973, 33482, 41676, 717, 33485, 25298, 729, 66269, 180959, 164580, 180969, 180972, 180974,
      180979, 180981, 180983, 767, 181003, 181020, 8991, 181027, 123687, 181033, 181034, 90926, 90950, 90951, 181076,
      870, 66406, 66419, 898, 66436, 907, 908, 914, 50067, 148373, 58271, 66466, 66468, 115621, 181162, 940, 91057,
      156595, 156597, 9141, 164802, 50115, 50116, 164803, 66502, 66503, 966, 140231, 140227, 50123, 17358, 9171, 33752,
      17375, 9185, 41964, 148462, 123886, 41968, 9202, 41971, 173042, 123893, 173043, 41976, 123904, 41989, 50188,
      25612, 25614, 1039, 25622, 74776, 50202, 50203, 66599, 1082, 25668, 50253, 66638, 99405, 9295, 25684, 9324, 33914,
      66692, 66695, 66697, 66698, 9355, 58507, 42130, 58520, 25757, 42146, 1188, 58534, 50343, 181416, 181417, 42154,
      181420, 50349, 181422, 181423, 181424, 181421, 9394, 1202, 50355, 1197, 1208, 1211, 74944, 1217, 181444, 25798,
      181476, 1261, 1266, 1269, 66807, 42231, 1271, 1272, 1277, 42240, 1281, 1280, 1285, 83206, 25863, 1293, 1295,
      165145, 1306, 156955, 1308, 1305, 1310, 91427, 1335, 116023, 17719, 116026, 1344, 58689, 17734, 83274, 58698,
      25934, 25943, 25956, 25960, 34165, 1401, 1404, 17805, 1424, 1430, 1443, 1446, 181677, 132526, 58799, 1462, 1466,
      1469, 1476, 91595, 173520, 1492, 1500, 181726, 1508, 1513, 58872, 67076, 50693, 42511, 17937, 67094, 26148, 17979,
      17983, 173633, 173634, 173635, 1607, 9801, 9804, 26197, 9819, 173668, 9831, 9832, 26221, 99961, 26238, 42622,
      34439, 26261, 9883, 9884, 34461, 26268, 34470, 116391, 9905, 181939, 34514, 9939, 116453, 9973, 149242, 182064,
      10033, 91953, 26423, 75576, 182073, 182074, 75578, 26425, 26424, 26429, 51004, 59198, 157499, 26435, 26443, 42829,
      182094, 10063, 10064, 182098, 42838, 132975, 100223, 182150, 42892, 18323, 42909, 182174, 182175, 165800, 92074,
      75690, 116652, 26544, 10163, 116674, 92101, 10181, 157652, 2036, 26612, 92150, 34814, 10243, 67588, 34821, 18466,
      34856, 18473, 18475, 10290, 133171, 26677, 92230, 26696, 67659, 10321, 100481, 166018, 182407, 182413, 116881,
      2207, 2211, 2218, 84149, 34998, 75973, 18637, 100570, 100575, 18659, 100581, 35064, 100601, 10495, 100610, 2312,
      2313, 157967, 10511, 10518, 18712, 2329, 43304, 76074, 10542, 149809, 149816, 2362, 149824, 18755, 35142, 26952,
      149832, 149841, 149854, 149860, 2408, 18793, 149865, 117103, 117113, 149882, 149883, 149884, 149891, 2440, 18828,
      117146, 117165, 10682, 18875, 141755, 2536, 43502, 2543, 43513, 59901, 2562, 109072, 150044, 43554, 43560, 2601,
      43563, 2613, 2616, 100927, 2624, 2631, 19016, 19023, 109151, 182882, 10860, 100978, 100982, 19068, 84605, 19071,
      19077, 117388, 158356, 27291, 158381, 60092, 182982, 60102, 10968, 19169, 19180, 109301, 19192, 35576, 19197,
      27391, 68362, 11020, 183062, 183067, 183077, 27432, 2875, 11071, 19266, 27463, 183118, 43855, 183126, 2907, 19292,
      11104, 158564, 158565, 19303, 68484, 19334, 19355, 109471, 11176, 2991, 2992, 11189, 52164, 19398, 93148, 19436,
      183302, 93199, 60432, 27668, 27673, 3099, 101416, 27691, 11312, 3122, 3127, 27704, 3133, 11330, 134214, 3143,
      3153, 3180, 3187, 3197, 142466, 134282, 3213, 93327, 183446, 142491, 134304, 142497, 134307, 134308, 3252, 3253,
      183477, 3258, 3265, 3270, 183497, 93386, 93390, 60628, 93396, 3286, 3294, 36085, 126199, 52473, 3326, 142607,
      142613, 134425, 36121, 36122, 60714, 60717, 3377, 52529, 60733, 52543, 52546, 159043, 159045, 52550, 159049,
      52554, 52555, 183627, 118097, 3411, 3412, 77140, 28009, 19823, 109938, 3444, 19830, 183671, 3452, 183683, 19844,
      60811, 3468, 167309, 19854, 3478, 159129, 159134, 159136, 3489, 3490, 36259, 3499, 36274, 36275, 36276, 183733,
      36279, 11706, 3516, 150974, 183743, 93632, 28102, 150982, 11724, 11731, 151000, 11739, 11742, 11743, 28131, 11748,
      151019, 118254, 11759, 28145, 11765, 36350, 28162, 11778, 11783, 11786, 11787, 11788, 28179, 11804, 11815, 167464,
      3628, 3632, 11827, 11828, 151093, 175672, 175673, 11838, 69197, 11854, 175696, 175698, 142931, 126550, 11863,
      183900, 3676, 36447, 11874, 175719, 20082, 11890, 167538, 20086, 11897, 20091, 175740, 20094, 20096, 175744,
      11907, 93838, 20118, 93851, 20126, 44704, 183978, 20138, 20148, 20158, 20161, 175814, 69323, 175837, 175838,
      175843, 175848, 159473, 44790, 44794, 3858, 36626, 36628, 36627, 36630, 36631, 36632, 118564, 118570, 126768,
      36657, 3913, 257887, 3944, 3984, 257942, 69528, 28572, 20394, 20399, 20400, 102329, 20416, 20422, 20423, 4042,
      159693, 20433, 20438, 20444, 159711, 45033, 258026, 77802, 77804, 258031, 258032, 77820, 4097, 45058, 77829,
      45065, 28683, 28684, 45074, 20498, 69652, 45077, 45085, 45089, 184355, 110633, 45101, 184369, 135221, 45110, 4150,
      184381, 127041, 102480, 20571, 4196, 20601, 61573, 20614, 102535, 20618, 20625, 102545, 184471, 77975, 102553,
      184474, 28831, 159907, 159912, 159913, 184489, 102579, 20667, 78014, 20697, 37082, 69851, 20710, 20715, 20720,
      20727, 20734, 20737, 20742, 20754, 12563, 4388, 184632, 12605, 184644, 184646, 61770, 53597, 20835, 20846, 119156,
      53621, 45434, 20862, 45454, 45455, 53653, 70038, 119189, 53656, 119194, 119200, 53676, 53679, 78267, 20924, 20925,
      20943, 37355, 21013, 12822, 29223, 21035, 4659, 62021, 45642, 4684, 21073, 4707, 94825, 45673, 12922, 4733, 21124,
      4742, 4749, 4752, 45733, 86694, 21162, 144062, 86722, 21194, 185035, 185034, 62166, 29399, 21214, 21225, 185066,
      185067, 168693, 37631, 160539, 258859, 176950, 176970, 4939, 29518, 29521, 176983, 176984, 176985, 176988, 176992,
      54113, 177017, 177032, 29578, 160667, 177073, 177074, 160706, 160737, 29690, 62464, 37903, 13329, 62482, 13331,
      13340, 259103, 259106, 259113, 259114, 259115, 259116, 21550, 37941, 21557, 29751, 259127, 13368, 21563, 259135,
      21567, 62531, 37958, 62534, 259145, 13386, 37965, 37978, 62559, 29792, 29797, 119911, 119914, 119931, 87167,
      38016, 87170, 87176, 29832, 119949, 78997, 119959, 259231, 79011, 21670, 259249, 79032, 79038, 259270, 120008,
      87242, 79053, 62694, 79086, 62706, 259318, 259319, 259320, 111882, 259342, 13600, 38219, 169305, 13658, 38250,
      13686, 111994, 30078, 30090, 30100, 13718, 13720, 30105, 259482, 13721, 79271, 79278, 38331, 177599, 177600,
      46534, 13777, 46576, 136699, 169484, 169485, 169486, 71183, 169487, 13849, 153113, 13851, 30247, 13863, 13881,
      177731, 13905, 177746, 13910, 71258, 46693, 259696, 259698, 153204, 22133, 259701, 22138, 259707, 30335, 13956,
      177801, 30346, 13984, 259763, 14005, 38583, 54968, 14020, 14024, 128720, 63184, 55007, 55008, 38635, 259830,
      161534, 79631, 38678, 38681, 112410, 38687, 14112, 79656, 71465, 30517, 30538, 46925, 128850, 128857, 128858,
      30565, 6001, 128893, 6024, 128905, 6028, 6030, 178069, 22422, 6038, 38813, 71582, 178078, 260000, 112545, 6049,
      260010, 260012, 79792, 260018, 79795, 112568, 112569, 260033, 128961, 260036, 14277, 6093, 153550, 153551, 104412,
      112606, 14308, 30699, 112634, 47104, 30726, 47119, 47126, 63514, 47131, 22575, 47160, 170048, 22606, 22608, 14429,
      79973, 170090, 120946, 96382, 104597, 170137, 137370, 170140, 22709, 63676, 260307, 121048, 260324, 63728, 63732,
      22803, 39189, 96551, 170281, 22840, 63821, 88433, 47499, 88462, 14737, 113064, 14770, 129476, 22990, 104925,
      72178, 55805, 170497, 137735, 23048, 113164, 162317, 39438, 145937, 162324, 170518, 121377, 14883, 31269, 39482,
      39491, 39507, 170587, 170588, 170589, 170590, 170591, 170592, 170593, 170594, 6747, 14961, 14969, 170639, 31388,
      80546, 88739, 31398, 31411, 31414, 72378, 72381, 162497, 15051, 15052, 178893, 178894, 178892, 113357, 39642,
      15069, 15088, 88839, 56080, 15124, 97046, 170778, 31530, 170798, 113455, 97072, 121664, 105281, 170816, 47945,
      56144, 121689, 15200, 64353, 31605, 31606, 31608, 72575, 31633, 31636, 31647, 15266, 15267, 15273, 31663, 31677,
      97241, 162782, 31723, 179197, 138256, 31762, 121878, 31769, 89115, 31772, 64540, 31775, 179235, 138281, 31786,
      121902, 121904, 39991, 146492, 179264, 56384, 40005, 31822, 40019, 23643, 15456, 179306, 179308, 7278, 15471,
      138365, 7294, 7301, 171146, 89227, 15502, 64657, 179377, 163008, 40131, 40141, 40146, 40149, 40154, 171228, 31970,
      31972, 171243, 23806, 163091, 48412, 163101, 179487, 146726, 64808, 7474, 7478, 64826, 7485, 48446, 7491, 7497,
      48458, 7499, 32073, 48461, 64853, 32098, 40298, 105848, 56700, 89471, 89481, 89495, 73111, 89508, 89511, 89532,
      122304, 122305, 122306, 48579, 122307, 122309, 15825, 171485, 15841, 179697, 65026, 48644, 138766, 146966, 155159,
      15897, 114213, 179767, 48757, 48760, 179836, 16021, 65174, 16034, 16043, 16052, 16059, 48831, 16078, 16079, 16080,
      16086, 7898, 16092, 32479, 81635, 16123, 40718, 7955, 7975, 180008, 180010, 180012, 180014, 180015, 180016, 7990,
      171833, 7995, 57153, 57154, 180035, 16212, 57173, 24409, 32615, 32633, 49019, 57215, 16258, 32643, 16262, 16264,
      32650, 40842, 32655, 180113, 24475, 171949, 171957, 171961, 24510, 73663, 180161, 163778, 180165, 147399, 180167,
      180171, 180172, 180173, 171985, 180180, 106460, 106465, 147426, 172008, 147433, 172009, 172010, 180207, 147441,
      155637, 163829, 147452]

ebay_category = Table(
    'ebay_category', metadata,
    Column('category_id', String(64), nullable=False, default=''),
    Column('category_name', String(64), nullable=False, default=''),
    Column('level', TINYINT),
    Column('is_leaf', Boolean),
    Column('parent_id', String(64), nullable=False, default=''),
    Column('site', String(64), nullable=False, default=''),
    Column('category_id_path', String(64), nullable=False, default=''),
    Column('category_name_path', String(64), nullable=False, default=''),
    Column('update_time', DateTime, nullable=False),
    PrimaryKeyConstraint('category_id_path', 'site', name='pk')
)

shopee_category = Table(
    'shopee_category', metadata,
    Column('category_id', String(64), nullable=False, default=''),
    Column('category_name', String(128), nullable=False, default=''),
    Column('level', TINYINT),
    Column('is_leaf', TINYINT),
    Column('parent_id', String(32), nullable=False, default=''),
    Column('site', String(8), nullable=False, default=''),
    Column('category_id_path', String(128), nullable=False, default=''),
    Column('category_name_path', String(523), nullable=False, default=''),
    Column('update_time', DateTime, nullable=False),
    PrimaryKeyConstraint('category_id_path', 'site', name='pk')
)

engine = None


async def db_engine_init():
    global engine
    engine = await create_engine(echo=SQLALCHEMY_ECHO, pool_recycle=SQLALCHEMY_POOL_RECYCLE,
                                 user=DB_USER_NAME, db=DB_DATABASE_NAME,
                                 host=DB_SEVER_ADDR, port=DB_SEVER_PORT, password=DB_USER_PW,
                                 autocommit=AUTOCOMMIT,
                                 maxsize=10)


import pandas as pd

CSV_FILE_PATH = './shopee_category.csv'
unexist_category = []
real_category = []


def condi():
    global real_category
    data = pd.read_csv(CSV_FILE_PATH)
    kk = list(set([]))
    # c_id = data.loc[:, ['一级Id']].values.tolist()
    # for i in c_id:
    #     kk.append(i[0])
    # kk = list(set(kk))
    c_1 = data.loc[:, ['site', 'category_name', 'category_id']]
    c_1 = c_1.to_dict(orient='records')
    # c_1 = [x['一级Id'] for x in c_1 if x['一级Id'] in c_id]
    for i in c_1:
        if i['category_id'] not in kk:
            kk.append(i['category_id'])
            real_category.append(i)
    print("done real")
    # kk.append({
    #     c1['站点']
    # })
    # real_category.extend(list(set([x['一级Id'] for x in data.iteritems()])))
    # real_category.extend(list(set([x for x in data['二级Id']])))
    # data.index = data['一级Id']
    # data.loc['']
    # print(real_category)


async def get_dif():
    async with engine.acquire() as conn:
        select_di = select([shopee_category])
        cursor = await conn.execute(select_di)
        record = await cursor.fetchall()
        dict1 = [{"cid": category2['category_id'], "site": category2['site']} for category2 in record]
        # exist_id = [category1['category_id'] for category1 in record]
        # print(exist_id)
        kk = []
        # site_dict = {
        #     "US": 'us',
        #     "Australia": 'au',
        #     "Germany": 'de',
        #     "UK": 'uk',
        #     "eBayMotors": "eBayMotors",
        #     "Canada": "Canada",
        #     "France": "France",
        #     "Italy": "Italy",
        #     "Spain": "Spain"
        # }
        site_dict = {
            "ID": 'id',
            "MY": 'my',
            "PH": 'ph',
            "SG": 'sg',
            "TW": "tw",
            "VN": "vn"
        }
        effect_site = ['ID', 'MY', 'PH', 'SG', 'TW']
        real_2 = copy.deepcopy(real_category)
        for i in real_category:
            for j in dict1:
                if str(i['category_id']) == j['cid'] and site_dict[i['site']] == j['site']:
                    real_2.remove(i)
        print("done remove")
        for i in real_2:
            if i['site'] in effect_site:
                kk.append(i)
                print("append effect")
        print(kk)


if __name__ == '__main__':
    condi()
    loop = asyncio.get_event_loop()
    loop.run_until_complete(db_engine_init())
    loop.run_until_complete(get_dif())
